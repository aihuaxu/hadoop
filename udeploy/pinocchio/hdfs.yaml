schema_version: 2.0.0
service_name: hdfs
service_type: java_8_standard

java_8_standard:
  build_cmds:
    - RUN echo 'This is hdfs build'
  post_build_cmds:
    - RUN echo hdfs hadoop supergroup | xargs -n 1 groupadd -r && useradd -r -m -s /bin/bash -g hadoop -g hdfs hdfs && usermod -a -G sudo,supergroup udocker && sed -i -e 's/%sudo\s\+ALL=(ALL:ALL)\s\+ALL/%sudo ALL=(ALL) NOPASSWD:ALL/g' /etc/sudoers
    - RUN mkdir -p /opt/hdfs/binary /opt/hdfs/conf /opt/hdfs/scripts /opt/hadoop/keytabs /var/log/hadoop /opt/hdfs/hosts
    - RUN chmod 777 /var/log/hadoop && chown -R udocker:udocker /opt/hdfs && chown -R udocker:udocker /opt/hadoop && chown -R udocker:udocker /run
    - RUN wget -O /tmp/hadoop.tar.gz http://artifactory.uber.internal:4587/artifactory/pub/hadoop/binary/${GIT_REF}/hadoop.tar.gz && tar -zxf /tmp/hadoop.tar.gz -C /opt/hdfs/binary --strip 1 && rm -f /tmp/hadoop.tar.gz
      # Setup cron for NameNode host files refresh. TODO: Move this to Odin remote execution.
    - RUN cp -r ./udeploy/nn_refresh_nodes.sh /opt/hdfs/scripts/
    - RUN echo '* * * * * root /opt/hdfs/scripts/nn_refresh_nodes.sh > /var/log/cron.log 2>/var/log/cron.log' > /etc/cron.d/nn_refresh_nodes
    - RUN echo '' >> /etc/cron.d/nn_refresh_nodes
    - RUN chmod 0644 /etc/cron.d/nn_refresh_nodes
    - RUN crontab /etc/cron.d/nn_refresh_nodes
    - RUN touch /var/log/cron.log

debian_packages_for_build:
  - name: cron
  - name: curl
  - name: gettext-base
  - name: krb5-user
  - name: sudo
  - name: tar
  - name: wget
  - name: vim

debian_packages_for_runtime:
  - name: rsync

applications:
  - udeploy_app_id: hdfs
    app_type: command_line
    command_line:
      run_cmd: '/bin/bash ./udeploy/hdfs/start.sh'
    health_check: none
