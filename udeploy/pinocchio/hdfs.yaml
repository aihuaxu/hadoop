schema_version: 2.0.0
service_name: hdfs
service_type: java_8_standard

java_8_standard:
  build_cmds:
    - RUN echo 'This is hdfs build'
  post_build_cmds:
    - RUN mkdir -p /etc/ubernss && chown udocker:udocker /etc/ubernss && sed -Ei '/^passwd|^group/{/uber/!s/$/ uber/}' /etc/nsswitch.conf
    - RUN sed -i -e 's/%sudo\s\+ALL=(ALL:ALL)\s\+ALL/%sudo ALL=(ALL) NOPASSWD:ALL/g' /etc/sudoers
    - RUN mkdir -p /opt/hdfs/binary /opt/hdfs/conf /var/log/hadoop /opt/hadoop/keytabs /var/log/hadoop
    - RUN chmod 777 /var/log/hadoop && chown -R udocker:udocker /opt/hdfs && chown -R udocker:udocker /opt/hadoop && chown -R udocker:udocker /run
    - RUN wget -O /tmp/hadoop.tar.gz http://artifactory.uber.internal:4587/artifactory/pub/hadoop/binary/${GIT_REF}/hadoop.tar.gz && tar -zxf /tmp/hadoop.tar.gz -C /opt/hdfs/binary --strip 1 && rm -f /tmp/hadoop.tar.gz

debian_packages_for_build:
  - name: cron
  - name: curl
  - name: gettext-base
  - name: krb5-user
  - name: sudo
  - name: tar
  - name: wget
  - name: vim

debian_packages_for_runtime:
  - name: rsync
  - name: uber-usergroups
  - name: ubernss

applications:
  - udeploy_app_id: hdfs
    app_type: command_line
    command_line:
      run_cmd: '/usr/bin/usergroups-exec -t 5m -d data -- /bin/bash ./udeploy/hdfs/start.sh'
    health_check: none